# IntegraciÃ³n de Calendly - CreaciÃ³n ProgramÃ¡tica de Eventos

## DescripciÃ³n

Esta integraciÃ³n permite crear eventos de Calendly de manera programÃ¡tica a travÃ©s de un endpoint REST API, utilizando la autenticaciÃ³n de Google OAuth y guardando los eventos en MongoDB.

## CaracterÃ­sticas

- âœ… AutenticaciÃ³n con Google OAuth
- âœ… CreaciÃ³n programÃ¡tica de eventos de Calendly
- âœ… ValidaciÃ³n de horarios disponibles
- âœ… GeneraciÃ³n de links de agendado single-use
- âœ… Almacenamiento en MongoDB
- âœ… Interfaz web para pruebas
- âœ… Manejo de webhooks de Calendly

## ConfiguraciÃ³n

### 1. Variables de Entorno

AsegÃºrate de tener configuradas las siguientes variables en tu archivo `.env`:

```env
# Google OAuth Configuration
GOOGLE_CLIENT_ID=your_google_client_id_here
GOOGLE_CLIENT_SECRET=your_google_client_secret_here
GOOGLE_CALLBACK_URL=http://localhost:3000/google/callback

# JWT Configuration
JWT_SECRET=your_jwt_secret_key_here

# MongoDB Configuration
MONGO_PASSWORD=your_mongodb_password_here
MONGO_URI=mongodb+srv://keirmauz:${MONGO_PASSWORD}@cluster0.yvdjajg.mongodb.net/Calendly

# Calendly OAuth Configuration
CALENDLY_CLIENT_ID=your_calendly_client_id_here
CALENDLY_CLIENT_SECRET=your_calendly_client_secret_here
CALENDLY_REDIRECT_URL=http://localhost:3000/calendly/callback

# Calendly Access Token (para creaciÃ³n programÃ¡tica)
CALENDLY_ACCESS_TOKEN=your_calendly_access_token_here

# Frontend URL
FRONTEND_URL=http://localhost:5173

# Server Configuration
PORT=3000
NODE_ENV=development
```

### 2. InstalaciÃ³n de Dependencias

```bash
# Backend
npm install class-validator class-transformer

# Frontend (ya estÃ¡ configurado)
cd frontend/frontend
npm install
```

## Uso

### 1. Iniciar el Backend

```bash
npm run start:dev
```

El servidor estarÃ¡ disponible en `http://localhost:3000`

### 2. Iniciar el Frontend

```bash
cd frontend/frontend
npm run dev
```

El frontend estarÃ¡ disponible en `http://localhost:5173`

### 3. AutenticaciÃ³n

1. Ve a `http://localhost:5173`
2. Haz clic en "Iniciar SesiÃ³n con Google"
3. Completa el proceso de autenticaciÃ³n
4. SerÃ¡s redirigido de vuelta al frontend

### 4. Crear Eventos ProgramÃ¡ticos

1. Ve a la secciÃ³n "Calendly" en el frontend
2. Encuentra la secciÃ³n "ðŸŽ¯ Crear Evento ProgramÃ¡tico"
3. Completa el formulario con:
   - Fecha y hora de inicio
   - Fecha y hora de fin
   - Nombre de la persona
   - PaÃ­s
   - Email (opcional)
   - TelÃ©fono (opcional)
   - Notas (opcional)
4. **Nueva funcionalidad**: Marca la casilla "ðŸ”— Abrir link de Calendly automÃ¡ticamente" si quieres que el link se abra automÃ¡ticamente
5. Haz clic en "Crear Evento"
6. RecibirÃ¡s un link de Calendly para agendar la cita
7. **RedirecciÃ³n automÃ¡tica**: Si tienes activada la opciÃ³n, el link se abrirÃ¡ automÃ¡ticamente en una nueva pestaÃ±a

## RedirecciÃ³n AutomÃ¡tica a Calendly

### ðŸš€ Nueva Funcionalidad

El sistema ahora incluye **redirecciÃ³n automÃ¡tica** al link de Calendly cuando se crea un evento programÃ¡tico.

#### CaracterÃ­sticas:

1. **Checkbox de Control**: 
   - OpciÃ³n "ðŸ”— Abrir link de Calendly automÃ¡ticamente"
   - Activado por defecto para mejor experiencia de usuario

2. **Dos Modos de OperaciÃ³n**:
   - **AutomÃ¡tico**: El link se abre inmediatamente en una nueva pestaÃ±a
   - **Manual**: Se muestra una confirmaciÃ³n antes de abrir el link

3. **Experiencia Mejorada**:
   - Mensaje de confirmaciÃ³n claro
   - Link visible en el mensaje
   - Apertura en nueva pestaÃ±a (no interrumpe el flujo de trabajo)

#### Ejemplo de Uso:

```javascript
// El usuario crea un evento
const eventData = {
  start_time: "2024-06-01T10:00:00.000Z",
  end_time: "2024-06-01T10:30:00.000Z",
  name: "Juan PÃ©rez",
  country: "MX",
  email: "juan@example.com"
};

// El sistema responde con:
{
  "success": true,
  "data": {
    "schedulingLink": "https://calendly.com/d/cv22-6jc-rkc/15-minute-meeting",
    "message": "Evento creado exitosamente. Use el link para agendar la cita."
  }
}

// Si autoRedirect estÃ¡ activado:
// â†’ Se abre automÃ¡ticamente: https://calendly.com/d/cv22-6jc-rkc/15-minute-meeting
// â†’ Mensaje: "âœ… Evento creado exitosamente! El link de Calendly se ha abierto en una nueva pestaÃ±a."

// Si autoRedirect estÃ¡ desactivado:
// â†’ ConfirmaciÃ³n: "Â¿Deseas abrir el link de agendado en Calendly?"
// â†’ El usuario decide si abrir o no
```

## API Endpoints

### Crear Evento ProgramÃ¡tico

```http
POST /api/calendly/create-event
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "start_time": "2024-06-01T10:00:00.000Z",
  "end_time": "2024-06-01T10:30:00.000Z",
  "name": "Juan PÃ©rez",
  "country": "MX",
  "email": "juan@example.com",
  "phone": "+52 123 456 7890",
  "notes": "Consulta sobre servicios"
}
```

**Respuesta exitosa:**
```json
{
  "success": true,
  "data": {
    "event": {
      "_id": "...",
      "calendlyEventId": "programmatic_1234567890",
      "eventType": "15 Minute Meeting",
      "startTime": "2024-06-01T10:00:00.000Z",
      "endTime": "2024-06-01T10:30:00.000Z",
      "inviteeName": "Juan PÃ©rez",
      "inviteeEmail": "juan@example.com",
      "country": "MX",
      "schedulingLink": "https://calendly.com/d/abcd-brv8/15-minute-meeting"
    },
    "schedulingLink": "https://calendly.com/d/abcd-brv8/15-minute-meeting",
    "message": "Evento creado exitosamente. Use el link para agendar la cita."
  }
}
```

### Verificar Estado de AutenticaciÃ³n

```http
GET /api/auth/status
```

### Obtener Eventos

```http
GET /api/calendly/events
```

### Obtener EstadÃ­sticas

```http
GET /api/calendly/stats
```

### Eliminar Webhook Subscription

```http
DELETE /api/calendly/webhook-subscriptions/{webhook_uuid}?token={access_token}
```

**Ejemplo:**
```bash
curl --request DELETE \
  --url "https://api.calendly.com/webhook_subscriptions/webhook_uuid" \
  --header "Authorization: Bearer {access_token}" \
  --header "Content-Type: application/json"
```

**Respuesta exitosa:**
```json
{
  "success": true,
  "data": { "success": true },
  "message": "Webhook subscription eliminado exitosamente"
}
```

## Flujo de CreaciÃ³n de Eventos

1. **ValidaciÃ³n de Usuario**: El endpoint verifica que el usuario estÃ© autenticado con Google
2. **ObtenciÃ³n de Token**: Se obtiene el token de acceso de Calendly desde las variables de entorno
3. **Consulta de Tipos de Eventos**: Se obtienen los tipos de eventos disponibles en Calendly
4. **CreaciÃ³n AutomÃ¡tica**: Si no hay tipos de eventos, se crea uno por defecto automÃ¡ticamente
5. **VerificaciÃ³n de Disponibilidad**: Se verifica que haya horarios disponibles (opcional, continÃºa si falla)
6. **CreaciÃ³n de Link**: Se crea un link de agendado single-use
7. **Almacenamiento**: Se guarda la informaciÃ³n del evento en MongoDB
8. **Respuesta**: Se devuelve el link de agendado y la confirmaciÃ³n

## Estructura de la Base de Datos

### Event Schema

```javascript
{
  calendlyEventId: String,      // ID Ãºnico del evento
  eventType: String,            // Tipo de evento de Calendly
  startTime: Date,              // Fecha y hora de inicio
  endTime: Date,                // Fecha y hora de fin
  inviteeEmail: String,         // Email del invitado
  inviteeName: String,          // Nombre del invitado
  inviteePhone: String,         // TelÃ©fono del invitado
  organizerEmail: String,       // Email del organizador (usuario autenticado)
  organizerName: String,        // Nombre del organizador
  location: String,             // UbicaciÃ³n del evento
  description: String,          // DescripciÃ³n del evento
  status: String,               // Estado del evento (pending, active, canceled)
  calendlyUri: String,          // URI del evento en Calendly
  eventTypeUri: String,         // URI del tipo de evento
  schedulingLink: String,       // Link de agendado
  country: String,              // PaÃ­s del evento
  calendlyData: Object,         // Datos completos de Calendly
  webhookType: String,          // Tipo de webhook
  webhookProcessed: Boolean,    // Si el webhook fue procesado
  webhookProcessedAt: Date      // Fecha de procesamiento del webhook
}
```

## Seguridad

- âœ… AutenticaciÃ³n JWT requerida para crear eventos
- âœ… ValidaciÃ³n de datos de entrada
- âœ… Manejo seguro de tokens de Calendly
- âœ… Cookies HTTP-only para JWT
- âœ… ValidaciÃ³n de fechas y rangos de tiempo

## Troubleshooting

### Error: "Token de acceso de Calendly no configurado"
- Verifica que `CALENDLY_ACCESS_TOKEN` estÃ© configurado en tu `.env`

### Error: "No se encontraron tipos de eventos disponibles"
- El sistema crearÃ¡ automÃ¡ticamente un tipo de evento por defecto
- Si persiste el error, verifica que el token tenga permisos para crear tipos de eventos
- Verifica que el usuario de Calendly tenga permisos de administrador

### Error: "No hay horarios disponibles"
- El sistema continuarÃ¡ creando el link de agendado incluso sin verificar disponibilidad
- Para eventos reciÃ©n creados, puede tomar tiempo para que Calendly configure la disponibilidad
- Verifica que las fechas estÃ©n en el futuro
- El rango de fechas se ajusta automÃ¡ticamente a mÃ¡ximo 7 dÃ­as

### Error: "Usuario no autenticado"
- AsegÃºrate de haber iniciado sesiÃ³n con Google
- Verifica que las cookies estÃ©n habilitadas en el navegador

## Desarrollo

### Estructura de Archivos

```
src/
â”œâ”€â”€ calendly/
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ create-event.dto.ts
â”‚   â”‚   â””â”€â”€ calendly-response.dto.ts
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ event.schema.ts
â”‚   â”œâ”€â”€ calendly.controller.ts
â”‚   â”œâ”€â”€ calendly.service.ts
â”‚   â””â”€â”€ calendly.module.ts
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”œâ”€â”€ google.strategy.ts
â”‚   â””â”€â”€ jwt.strategy.ts
â””â”€â”€ main.ts
```

### Agregar Nuevos Tipos de Eventos

Para agregar nuevos tipos de eventos, modifica la lÃ³gica en `calendly.service.ts`:

```typescript
// En el mÃ©todo selectBestEventType
const selectedEventType = eventTypes.find(type => 
  type.name === 'Tu Tipo de Evento EspecÃ­fico'
) || this.selectBestEventType(eventTypes);
```

### LÃ³gica de SelecciÃ³n de Eventos

El sistema selecciona automÃ¡ticamente el mejor tipo de evento disponible:

1. **Prioriza eventos activos** y de tipo estÃ¡ndar
2. **Prefiere eventos one-on-one** (1 host, 1 invitado) sobre grupales
3. **Selecciona eventos con duraciÃ³n** entre 15-60 minutos
4. **Ordena por duraciÃ³n** (prefiere eventos mÃ¡s cortos)
5. **Fallback** a cualquier evento disponible si no hay opciones preferidas

### Tipos de Eventos de Calendly

- **One-on-One (Solo)**: 1 host, 1 invitado - Ideal para consultas individuales
- **Group**: MÃºltiples hosts/invitados - Para eventos grupales
- **Collective**: Todos los participantes deben estar disponibles
- **Round Robin**: Alterna entre diferentes hosts

### CreaciÃ³n AutomÃ¡tica de Tipos de Eventos

Si no hay tipos de eventos configurados, el sistema crea automÃ¡ticamente uno por defecto:

- **Nombre**: "Consulta One-on-One"
- **Tipo**: One-on-One (1 host, 1 invitado)
- **DuraciÃ³n**: 30 minutos
- **DescripciÃ³n**: "Consulta individual de 30 minutos"
- **Tipo**: StandardEventType
- **Kind**: Solo (evento individual)
- **Color**: Azul (#3B82F6)
- **Estado**: Activo

## ProducciÃ³n

Para desplegar en producciÃ³n:

1. Configura HTTPS
2. Cambia `secure: false` a `secure: true` en las cookies
3. Configura dominios correctos en las variables de entorno
4. Usa un JWT_SECRET fuerte
5. Configura variables de entorno de producciÃ³n para Calendly
6. Configura MongoDB Atlas para producciÃ³n

## Licencia

Este proyecto estÃ¡ bajo la licencia MIT. 